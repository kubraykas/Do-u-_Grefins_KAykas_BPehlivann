<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratejik Analiz Raporu - GreFins CBAM</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pageBg: '#0B1121',
                        cardBg: '#151E32',
                        primary: '#C9FD02',
                        textMain: '#FFFFFF',
                        textMuted: '#94A3B8',
                        borderDark: '#2D3748',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=4">
</head>

<body class="bg-pageBg text-textMain antialiased py-24 px-6 flex flex-col min-h-screen">
    <div class="max-w-[1400px] mx-auto w-full">
        <!-- Strategic Header -->
        <header
            class="flex flex-col lg:flex-row justify-between items-start lg:items-end gap-12 mb-24 pb-16 border-b border-borderDark/50">
            <div class="space-y-10">
                <a href="/">
                    <img src="{{ url_for('static', filename='favicon.png') }}" alt="GreFins" class="h-20 w-auto">
                </a>
                <div class="space-y-4">
                    <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-[1.1]">Stratejik <br>Analiz
                        Raporu
                    </h1>
                    <p class="text-xl text-textMuted max-w-2xl font-medium">AB standartlarına uyum ve karbon emisyonu
                        yönetimi için akıllı yol haritanız.</p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-5">
                <a href="/download-pdf"
                    class="bg-primary hover:bg-primaryHover text-pageBg font-black text-xs px-10 py-5 rounded-full transition-all uppercase tracking-widest flex items-center gap-4 shadow-xl">
                    Stratejik Raporu İndir (PDF)
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </a>
            </div>
        </header>

        <div class="grid lg:grid-cols-12 gap-12">
            <!-- Sidebar: Key Intelligence -->
            <aside class="lg:col-span-4 space-y-8">
                <div class="bg-cardBg border border-borderDark rounded-[32px] p-10 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-primary/40"></div>
                    <h3 class="text-[10px] font-black text-textMuted uppercase tracking-[0.3em] mb-10">Maliyet Portföyü
                    </h3>
                    <div class="space-y-8">
                        <div>
                            <div class="text-[10px] text-textMuted uppercase font-black tracking-widest mb-2">Yıllık
                                Emisyon Yükü</div>
                            <div class="text-3xl font-black tracking-tighter">{{
                                "{:,.1f}".format(cbam_summary['total_emission']) }} tCO2e</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-primary uppercase font-black tracking-widest mb-2">Güncel CBAM
                                Maliyeti</div>
                            <div class="text-5xl font-black text-primary tracking-tighter">€{{
                                "{:,.0f}".format(cbam_summary['cbam_cost']) }}</div>
                        </div>
                    </div>
                </div>

                <!-- Visual Charts Section in Sidebar -->
                <div class="bg-cardBg border border-borderDark rounded-[32px] p-8 shadow-2xl space-y-10">
                    <div>
                        <h3 class="text-[9px] font-black text-textMuted uppercase tracking-[.3em] mb-6">Emisyon Dağılımı
                        </h3>
                        <canvas id="emissionChart" height="200"></canvas>
                    </div>
                    <div>
                        <h3 class="text-[9px] font-black text-textMuted uppercase tracking-[.3em] mb-6">Maliyet
                            Projeksiyonu</h3>
                        <canvas id="costChart" height="200"></canvas>
                    </div>
                </div>

                <div class="bg-cardBg border border-borderDark rounded-[32px] p-10 shadow-2xl">
                    <h3 class="text-[10px] font-black text-textMuted uppercase tracking-[0.3em] mb-10">Pazar Verileri
                        (EU ETS)</h3>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <div class="text-[10px] text-textMuted font-black mb-2 uppercase tracking-widest">Spot Fiyat
                            </div>
                            <div class="text-xl font-black">€{{ "{:.2f}".format(ets_stats.last_price) }}</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-textMuted font-black mb-2 uppercase tracking-widest">Yıllık
                                Ort.</div>
                            <div class="text-xl font-black">€{{ "{:.2f}".format(ets_stats.mean_price) }}</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content: Forecasts & AI Insights -->
            <main class="lg:col-span-8 space-y-16">
                <!-- Forecast Section -->
                <section>
                    <div class="flex items-center gap-6 mb-10">
                        <div class="h-px flex-1 bg-borderDark/50"></div>
                        <h2 class="text-xs font-black uppercase tracking-[0.4em] text-primary whitespace-nowrap">ETS
                            Fiyat Projeksiyonları</h2>
                        <div class="h-px flex-1 bg-borderDark/50"></div>
                    </div>
                    <div class="overflow-hidden border border-borderDark rounded-[24px] bg-cardBg shadow-xl">
                        <table class="w-full text-sm">
                            <thead>
                                <tr
                                    class="bg-[#0F1629] text-textMuted font-black text-[10px] uppercase tracking-[0.3em] text-left">
                                    <th class="p-6">Dönem</th>
                                    <th class="p-6">Tahmini Fiyat</th>
                                    <th class="p-6 text-right">Trend</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-borderDark/40">
                                {% for row in ets_forecast %}
                                <tr class="hover:bg-white/[0.02] transition-colors">
                                    <td class="p-6 font-black text-textMain">{{ row.Quarter }}</td>
                                    <td class="p-6 font-bold">€{{ "{:.2f}".format(row['Forecasted Value']) }}</td>
                                    <td class="p-6 text-right font-black">
                                        {% if loop.index > 1 %}
                                        {% set change = ((row['Forecasted Value'] -
                                        ets_forecast[loop.index-2]['Forecasted Value']) /
                                        ets_forecast[loop.index-2]['Forecasted Value'] * 100) %}
                                        {% if change > 0 %}
                                        <span class="text-red-400">+{{ "{:.1f}".format(change) }}%</span>
                                        {% else %}
                                        <span class="text-primary">{{ "{:.1f}".format(change) }}%</span>
                                        {% endif %}
                                        {% else %}
                                        <span class="opacity-20">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- AI Report Section -->
                <section>
                    <div class="flex items-center gap-6 mb-10">
                        <div class="h-px flex-1 bg-borderDark/50"></div>
                        <h2 class="text-xs font-black uppercase tracking-[0.4em] text-primary whitespace-nowrap">GreFins
                            AI Yönetici Özeti</h2>
                        <div class="h-px flex-1 bg-borderDark/50"></div>
                    </div>
                    <div class="bg-cardBg border border-borderDark rounded-[32px] p-12 shadow-2xl relative group">
                        <div class="absolute top-8 right-8 flex items-center gap-3">
                            <span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>
                            <span
                                class="text-[9px] font-black text-primary uppercase tracking-[0.2em] bg-primary/10 px-3 py-1 rounded-full border border-primary/20">AI
                                Intelligence Active</span>
                        </div>
                        <div id="markdown-content"
                            class="prose prose-invert prose-primary max-w-none text-textMain leading-[1.8] space-y-6 text-sm opacity-90 border-l-2 border-primary/20 pl-10">
                            {{ report.report_text }}
                        </div>
                    </div>
                </section>

                <!-- Optimization Section -->
                {% if optimization_scenarios %}
                <section>
                    <div class="flex items-center gap-6 mb-10">
                        <div class="h-px flex-1 bg-borderDark/50"></div>
                        <h2 class="text-xs font-black uppercase tracking-[0.4em] text-primary whitespace-nowrap">
                            Stratejik Optimizasyon Modelleri</h2>
                        <div class="h-px flex-1 bg-borderDark/50"></div>
                    </div>

                    <div class="space-y-6">
                        {% for key, scenario in (optimization_scenarios.items() if optimization_scenarios is mapping
                        else optimization_scenarios) %}
                        {% if key != 'combined' %}
                        <div
                            class="bg-cardBg border border-borderDark rounded-[32px] p-10 shadow-2xl relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-8">
                                <span class="text-primary font-black text-xs tracking-widest uppercase">ROI: {{
                                    "{:.1f}".format(scenario.get('roi_years', 0)) }} Yıl</span>
                            </div>
                            <div class="mb-8">
                                <h3 class="text-2xl font-black text-white mb-2">{{ scenario.get('name', 'İyileştirme')
                                    }}</h3>
                                <div class="flex gap-4">
                                    {% for step in scenario.get('measures', []) %}
                                    <span
                                        class="text-[9px] font-black text-textMuted uppercase tracking-widest bg-white/5 px-3 py-1 rounded-full">{{
                                        step }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 pt-8 border-t border-borderDark/30">
                                <div>
                                    <div class="text-[9px] font-black text-textMuted uppercase tracking-widest mb-1">
                                        Emisyon Tasarrufu</div>
                                    <div class="text-2xl font-black text-primary">{{
                                        "{:,.1f}".format(scenario.get('emission_saving_tco2', 0)) }} tCO2</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-black text-textMuted uppercase tracking-widest mb-1">
                                        Maliyet Tasarrufu</div>
                                    <div class="text-2xl font-black text-white">€{{
                                        "{:,.0f}".format(scenario.get('annual_cbam_saving_eur', 0)) }}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-black text-textMuted uppercase tracking-widest mb-1">
                                        Azaltım Hedefi</div>
                                    <div class="text-2xl font-black text-white">%{{ scenario.get('reduction_percent', 0)
                                        }}</div>
                                </div>
                                <div class="text-right">
                                    <button
                                        class="text-[10px] font-black text-pageBg bg-primary px-6 py-3 rounded-full uppercase tracking-tighter hover:scale-105 transition-all">
                                        Detaylı Plan
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            </main>
        </div>

        <footer
            class="mt-32 pt-16 border-t border-borderDark/50 flex flex-col md:flex-row justify-between items-center gap-10">
            <div class="text-[10px] font-black text-textMuted uppercase tracking-[0.4em] opacity-40">GreFins
                Intelligence System © 2026</div>
            <div class="flex gap-8">
                <a href="/"
                    class="text-[11px] font-black uppercase tracking-widest hover:text-primary transition-colors">Ana
                    Sayfa</a>
                <a href="/cn-codes"
                    class="text-[11px] font-black uppercase tracking-widest hover:text-primary transition-colors">Sektörler</a>
            </div>
        </footer>
    </div>

    <!-- Verileri JS tarafına güvenli aktarmak için JSON blokları -->
    <script id="analysis-data" type="application/json">
    {
        "scope1": {{ (emission_analysis.get('scope1', {}).get('total_scope1', 0) if emission_analysis else 0) | tojson }},
        "scope2": {{ (emission_analysis.get('scope2', {}).get('total_scope2', 0) if emission_analysis else 0) | tojson }},
        "forecast": {{ ets_forecast | tojson }}
    }
    </script>

    <script>
        // Data Loading from JSON block
        const analysisData = JSON.parse(document.getElementById('analysis-data').textContent);

        // Markdown Rendering
        const contentDiv = document.getElementById('markdown-content');
        if (contentDiv) {
            const rawText = contentDiv.textContent;
            contentDiv.innerHTML = marked.parse(rawText.trim());
        }

        // Charts Initialization
        const primaryColor = '#C9FD02';
        const mutedColor = '#94A3B8';
        const borderDark = '#2D3748';

        // 1. Emission Pie Chart
        const emissionCtx = document.getElementById('emissionChart').getContext('2d');
        if (analysisData.scope1 > 0 || analysisData.scope2 > 0) {
            new Chart(emissionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Scope 1', 'Scope 2'],
                    datasets: [{
                        data: [analysisData.scope1, analysisData.scope2],
                        backgroundColor: [primaryColor, '#10b981'],
                        borderColor: '#151E32',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: mutedColor, font: { weight: 'bold', size: 10 } }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // 2. Cost Projection Line Chart
        const costCtx = document.getElementById('costChart').getContext('2d');
        const forecast = analysisData.forecast;
        if (forecast && forecast.length > 0) {
            const labels = forecast.map(d => d.Id || d.Quarter);
            const prices = forecast.map(d => d['Predicted_Price'] || d['Forecasted Value'] || 0);

            new Chart(costCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ETS Fiyatı (€)',
                        data: prices,
                        borderColor: primaryColor,
                        backgroundColor: 'rgba(201, 253, 2, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: primaryColor,
                        pointBorderColor: '#151E32',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: mutedColor, font: { size: 9 } }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: mutedColor, font: { size: 9 } }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>